<div #mapEl class='map' [style.transform]='mapTransform()'></div>
<div #clusterLabelsEl style='display:none'>
    @if (map()) {
        <svg xmlns="http://www.w3.org/2000/svg" class='cluster-labels' [attr.width]='w()' [attr.height]='h()' [attr.viewBox]='"0 0 " + w() + " " + h()' [class.visible]='clusterLabelsVisible()'>
            <g transform="translate(0,0)">
                <rect [attr.x]='0' [attr.y]='0' [attr.width]='w()' [attr.height]='h()' fill='#fffdf6' opacity='0.5'></rect>
                @for (cluster of config().clusters; track $index) {
                    <!-- <path [attr.id]="'cluster-' + cluster.id" [attr.d]="
                        'M' + (cluster.x - cluster.w / 2) + ' ' + (cluster.y) +
                        ' C' + (cluster.x) + ' ' + (cluster.y + cluster.w * (cluster.y - h()/2) / h() / 3) +
                        ' ' + (cluster.x) + ' ' + (cluster.y + cluster.w * (cluster.y - h()/2) / h() / 3) +
                        ' ' + (cluster.x + cluster.w / 2) + ' ' + (cluster.y)"
                        fill='none' stroke='none' stroke-width='0'>
                    </path> -->

                    <g [attr.transform]='"translate(" + cluster.x + "," + cluster.y + ")"'  [class.positive]='cluster.average_rotation <= 0' [class.negative]='cluster.average_rotation > 0'>
                        <g [style.transform]='"rotate(" + (-cluster.average_rotation*2) + "deg)"'>
                        
                        <!-- text-anchor="middle" alignment-baseline="middle"  -->

                        <path [attr.id]="'cluster-' + $index" [attr.d]="
                            'M' + (- cluster.w / 3) + ' ' + (0) +
                            ' C' + (0) + ' ' + (cluster.w * (cluster.y - h()/2) / h() / 4) +
                            ' ' + (0) + ' ' + (cluster.w * (cluster.y - h()/2) / h() / 4) +
                            ' ' + (cluster.w / 3) + ' ' + (0)"
                            fill='none' stroke='none' stroke-width='0'>
                        </path>
                        <text x='0' y='0' 
                            [attr.font-size]="cluster.fontSize[lang()]"
                        >
                            <textPath [attr.href]="'#cluster-' + $index" method='stretch' lengthAdjust="spacing" 
                                      [attr.textLength]="cluster.w*0.66" side='left' spacing='auto'>
                                {{ cluster.title[lang()] }}
                            </textPath>
                        </text>
                    </g></g>
                }
            </g>
        </svg>
    }    
</div>
<div #maskEl class='mask-overlay' style='display:none'>
    <svg xmlns="http://www.w3.org/2000/svg" class='mask' [class.visible]='maskLayerVisible()'
        [attr.width]='wdim()' [attr.height]='hdim()' [attr.viewBox]='"0 0 " + wdim() + " " + hdim()' preserveAspectRatio="none">
        <mask id='mask'>
            <rect [attr.x]='0' [attr.y]='0' [attr.width]='wdim()' [attr.height]='hdim()' fill='white'></rect>
            <g transform="translate(0,0)" >
                @for (maskItem of maskItems(); track $index) {
                    <rect [attr.x]='maskItem.x' [attr.y]='maskItem.y' [attr.width]='1' [attr.height]='1' fill='black'></rect>
                }
            </g>
        </mask>
        <rect class='blur' [attr.x]='0' [attr.y]='0' [attr.width]='wdim()' [attr.height]='hdim()' fill='#fffdf6' mask='url(#mask)'></rect>
    </svg>
</div>
<div class='image-overlay' [class.visible]='itemImgVisible()'>
    @if (coneVisible()) {
        <div class='cone'>
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 1000 1000" fill="none">
                <g [class]="'expander ' + coneExpand()">
                    <g transform='translate(0,500)'>
                        <g class='probable preferred cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#698CFF' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#698CFF' font-size="24">Probable</text>
                        </g>
                        <g class='plausible preferred cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#698CFF' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#698CFF' font-size="24">Plausible</text>
                        </g>
                        <g class='possible preferred cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#698CFF' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#698CFF' font-size="24">Possible</text>
                        </g>
                        <g class='preposterous preferred cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#698CFF' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#698CFF' font-size="24">Preposterous</text>
                        </g>
                        <g class='probable prevent cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#F73C3C' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#F73C3C' font-size="24">Probable</text>
                        </g>                    
                        <g class='plausible prevent cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#F73C3C' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#F73C3C' font-size="24">Plausible</text>
                        </g>
                        <g class='possible prevent cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#F73C3C' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#F73C3C' font-size="24">Possible</text>
                        </g>
                        <g class='preposterous prevent cone-line' transform-origin="150 0">
                            <path class='line' d="M150 0 L850 0" stroke='#F73C3C' stroke-width="1"></path>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#F73C3C' font-size="24">Preposterous</text>
                        </g>
                        <g class='projected'>
                            <path class='line' d="M150 0 L850 0" stroke='#8F8F8F' stroke-width="1"></path>
                            <text class='now' x='150' y='0' dy="6" dx='-16' fill='#8F8F8F' font-size="24" text-anchor='end'>NOW</text>
                            <text class='label' x='850' y='0' dy="6" dx='16' fill='#8F8F8F' font-size="24" transform='translate(-650,0)'>PROJECTED</text>    
                            <circle class='circle' cx='150' cy='0' r='5' fill='#8F8F8F'></circle>
                        </g>    
                    </g>
                </g>
            </svg>
        </div>
    }
    <div class='clothespin-text prefer' [class.visible]='clothespinTextVisible() === "prefer" || clothespinTextVisible() === "both"'>
        Prefer
    </div>
    <div class='item-image' [style.transform]='overlayTransform()'>
        <img [src]='itemImg()'>
        <div class='clothespin prefer' [class.visible]='clothespinVisible() === "prefer" || clothespinVisible() === "both"' [class.selected]='clothespinSelected()'>
            <svg xmlns="http://www.w3.org/2000/svg" width="27" height="109" viewBox="0 0 27 109" fill="none">
                <rect x="4.74609" y="0.916992" width="17.875" height="107.61" rx="5.93681" fill="#7BB3EE"/>
                <rect x="7.7145" y="3.8854" width="11.9382" height="101.673" rx="2.9684" stroke="black" stroke-opacity="0.2" stroke-width="5.93681"/>
                <rect x="6.94141" y="73.9231" width="13.4761" height="4.71275" fill="black" fill-opacity="0.2"/>
                <path d="M6.94922 76.2804H23.8311L23.8311 39.5083" stroke="#7BB3EE" stroke-width="5.93681" stroke-linecap="round"/>
                <path d="M6.94922 76.2804H23.8311L23.8311 39.5083" stroke="black" stroke-opacity="0.5" stroke-width="5.93681" stroke-linecap="round"/>
                <path d="M3.88672 51.0888L3.88672 39.5083" stroke="#7BB3EE" stroke-width="5.93681" stroke-linecap="round"/>
                <path d="M3.88672 51.0888L3.88672 39.5083" stroke="black" stroke-opacity="0.5" stroke-width="5.93681" stroke-linecap="round"/>
            </svg>
        </div>
        <div class='clothespin prevent' [class.visible]='clothespinVisible() === "prevent" || clothespinVisible() === "both"' [class.selected]='clothespinSelected()'>
            <svg xmlns="http://www.w3.org/2000/svg" width="27" height="108" viewBox="0 0 27 108" fill="none">
                <rect x="4.28516" y="0.340332" width="17.875" height="107.61" rx="5.93681" fill="#F73C3C"/>
                <rect x="7.25356" y="3.30874" width="11.9382" height="101.673" rx="2.9684" stroke="black" stroke-opacity="0.2" stroke-width="5.93681"/>
                <rect x="6.48047" y="73.3464" width="13.4761" height="4.71275" fill="black" fill-opacity="0.2"/>
                <path d="M6.48828 75.7038H23.3701L23.3701 38.9316" stroke="#F73C3C" stroke-width="5.93681" stroke-linecap="round"/>
                <path d="M6.48828 75.7038H23.3701L23.3701 38.9316" stroke="black" stroke-opacity="0.5" stroke-width="5.93681" stroke-linecap="round"/>
                <path d="M3.42578 50.5122L3.42578 38.9316" stroke="#F73C3C" stroke-width="5.93681" stroke-linecap="round"/>
                <path d="M3.42578 50.5122L3.42578 38.9316" stroke="black" stroke-opacity="0.5" stroke-width="5.93681" stroke-linecap="round"/>
            </svg>            
        </div>
    </div>
    <div class='clothespin-text prevent' [class.visible]='clothespinTextVisible() === "prevent" || clothespinTextVisible() === "both"'>
        Prevent
    </div>
</div>
