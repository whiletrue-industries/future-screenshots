<div class="canvas-creator">
  <!-- Template Carousel -->
  @if (showTemplateGallery()) {
    <div class="template-gallery" [class.transitioning]="isTransitioning()">
      <div class="gallery-background"></div>
      <div class="gallery-content">
        <h1 class="gallery-title" i18n>Choose a Template</h1>
        <div class="carousel-wrapper">
          <div class="carousel"
               [class.animating]="isCarouselAnimating()"
               [style.transform]="carouselTransform()"
               (touchstart)="onCarouselTouchStart($event)"
               (touchmove)="onCarouselTouchMove($event)"
               (touchend)="onCarouselTouchEnd()">
            @for (template of templates; track template.id; let i = $index) {
              <div class="carousel-item"
                   [class.active]="i === currentTemplateIndex()"
                   [class.expanding]="isTemplateExpanding() && i === currentTemplateIndex()"
                   (click)="currentTemplateIndex.set(i); useCurrentTemplate()">
                <div class="carousel-item-content">
                  <img [src]="template.preview" [alt]="template.name" loading="lazy">
                  <div class="template-label">{{ template.name }}</div>
                </div>
              </div>
            }
          </div>
        </div>
        <div class="carousel-controls">
          <button class="carousel-nav prev" 
                  (click)="previousTemplate()"
                  [disabled]="isCarouselAnimating()"
                  aria-label="Previous template">‚Äπ</button>
          <button class="carousel-nav next" 
                  (click)="nextTemplate()"
                  [disabled]="isCarouselAnimating()"
                  aria-label="Next template">‚Ä∫</button>
        </div>
      </div>
    </div>
  }
  
  <!-- Canvas Editor -->
  @if (selectedTemplate() && !showTemplateGallery()) {
    <div class="editor" [class.entering]="isEditorShowing()">
      <!-- Top drawer overlay controls -->
      <div class="top-drawer" [class.state-default]="drawerState() === 'default'" [class.state-full]="drawerState() === 'full'" [class.state-minimal]="drawerState() === 'minimal'"
           [style.transform]="drawerTransform()" [style.transition]="drawerTransition()">
        <div class="drawer-content" (touchstart)="onDrawerTouchStart($event)" (touchmove)="onDrawerTouchMove($event)" (touchend)="onDrawerTouchEnd()">
          <!-- Advanced (only in full) -->
          @if (drawerState() === 'full') {
          <div class="row extended advanced">
            <button class="icon" (click)="addText()" aria-label="Add text">‚ûïT</button>
            <button class="icon" (click)="addTransitionText()" aria-label="Add transition text">T‚Üï</button>
            <div class="font-picker">
              <select [value]="selectedFont()" (change)="setFont(($any($event.target)).value)">
                @for (f of handwritingFonts; track f) {
                  <option [value]="f">{{ f }}</option>
                }
              </select>
            </div>
            <button class="icon" (click)="undo()" aria-label="Undo">‚Ü©Ô∏é</button>
          </div>
          <div class="row extended advanced">
            <div class="line-height-control">
              <label for="line-height">Line Height</label>
              <input type="range" id="line-height" min="0.8" max="2" step="0.1" 
                     [value]="selectedLineHeight()" 
                     (input)="setLineHeight(+($any($event.target)).value)">
              <span>{{ (selectedLineHeight() * 100).toFixed(0) }}%</span>
            </div>
            <div class="line-height-control">
              <label for="text-height">Height</label>
              <input type="range" id="text-height" min="20" max="200" step="5" 
                     [value]="selectedHeight()" 
                     (input)="setHeight(+($any($event.target)).value)">
              <span>{{ selectedHeight() }}px</span>
            </div>
            <div class="transition-selector inline">
              <button class="chip" [class.selected]="transitionChoice() === 'before'" (click)="selectTransition('before')" i18n>Before</button>
              <button class="chip" [class.selected]="transitionChoice() === 'during'" (click)="selectTransition('during')" i18n>During</button>
              <button class="chip" [class.selected]="transitionChoice() === 'after'" (click)="selectTransition('after')" i18n>After</button>
            </div>
          </div>
          }

          <!-- Basic buttons (default & full) -->
          @if (drawerState() !== 'minimal') {
          <div class="row core">
            <button class="icon" [class.active]="currentMode() === 'type'" (click)="setMode('type')" aria-label="Text mode">‚úçÔ∏è</button>
            <button class="icon" [class.active]="currentMode() === 'draw'" (click)="setMode('draw')" aria-label="Draw mode">üñä</button>
            <button class="icon" (click)="clearCanvas()" aria-label="Clear">üóë</button>
            <button class="icon primary" (click)="submit()" aria-label="Submit">‚§¥</button>
          </div>
          }
        </div>
        <div class="drawer-handle" (click)="toggleControls()" (touchstart)="onDrawerTouchStart($event)" (touchmove)="onDrawerTouchMove($event)" (touchend)="onDrawerTouchEnd()" aria-label="Toggle controls" role="button" tabindex="0"></div>
      </div>
      
      <div class="canvas-container">
        <canvas #canvasEl></canvas>
      </div>
    </div>
  }
</div>
