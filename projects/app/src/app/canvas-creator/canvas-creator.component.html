<div class="canvas-creator">
  <!-- Template Carousel -->
  @if (showTemplateGallery()) {
    <div class="template-gallery" [class.transitioning]="isTransitioning()">
      <div class="gallery-background"></div>
      <div class="gallery-content">
        <div class="gallery-header">
          <button class="back-button" [routerLink]="['/prescan']" queryParamsHandling="merge" aria-label="Back to prescan">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <h1 class="gallery-title" i18n>Choose a Template</h1>
          <div class="spacer"></div>
        </div>
        <div class="carousel-wrapper">
          <div class="carousel"
               [class.animating]="isCarouselAnimating()"
               [style.transform]="carouselTransform()"
               [style.transition]="carouselTransition()"
               (touchstart)="onCarouselTouchStart($event)"
               (touchmove)="onCarouselTouchMove($event)"
               (touchend)="onCarouselTouchEnd()">
            @for (template of templates(); track template.id; let i = $index) {
              <div class="carousel-item"
                   [class.active]="i === currentTemplateIndex()"
                   [class.expanding]="isTemplateExpanding() && i === currentTemplateIndex()"
                   (click)="currentTemplateIndex.set(i); useCurrentTemplate()">
                <div class="carousel-item-content">
                  <img [src]="template.preview" [alt]="template.name" loading="lazy">
                  <div class="template-label">{{ template.name }}</div>
                </div>
              </div>
            }
          </div>
        </div>
        <div class="carousel-controls">
          <button class="carousel-nav prev" 
                  (click)="previousTemplate()"
                  [disabled]="isCarouselAnimating()"
                  aria-label="Previous template">‹</button>
          <button class="carousel-nav next" 
                  (click)="nextTemplate()"
                  [disabled]="isCarouselAnimating()"
                  aria-label="Next template">›</button>
        </div>
      </div>
    </div>
  }
  
  <!-- Canvas Editor -->
  @if (selectedTemplate() && !showTemplateGallery()) {
    <div class="editor" [class.entering]="isEditorShowing()">
      <div class="canvas-container">
        <canvas #canvasEl></canvas>
      </div>
      
      <!-- Bottom Control Bar -->
      <div class="control-bar">
        <button class="control-btn close" (click)="showTemplateGallery.set(true)" aria-label="Close and return to template selection" title="Back to templates">
          <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.78629 9.73336C10.2255 9.29423 10.9379 9.2944 11.3773 9.73336L18.0002 16.3563L24.6217 9.73475C25.0611 9.29541 25.7734 9.29541 26.2127 9.73475C26.652 10.1741 26.652 10.8864 26.2127 11.3257L19.5912 17.9473L26.2127 24.5688C26.652 25.0081 26.652 25.7204 26.2127 26.1598C25.7734 26.5991 25.0611 26.5991 24.6217 26.1598L18.0002 19.5383L11.3773 26.1612C10.9379 26.6001 10.2255 26.6003 9.78629 26.1612C9.34706 25.7219 9.34729 25.0095 9.78629 24.5702L16.4092 17.9473L9.78629 11.3244C9.34729 10.885 9.34706 10.1726 9.78629 9.73336Z" fill="white"/></svg>
        </button>
        @if (showAlignmentToggle()) {
          <button class="control-btn alignment" (click)="toggleAlignment()" aria-label="Toggle text alignment" [title]="'Align: ' + activeTextboxAlignment()">
            @if (activeTextboxAlignment() === 'left') {
              <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="7" y1="10" x2="29" y2="10" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="7" y1="15" x2="23" y2="15" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="7" y1="20" x2="27" y2="20" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="7" y1="25" x2="21" y2="25" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            } @else if (activeTextboxAlignment() === 'center') {
              <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="7" y1="10" x2="29" y2="10" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="11" y1="15" x2="25" y2="15" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="9" y1="20" x2="27" y2="20" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="13" y1="25" x2="23" y2="25" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            } @else {
              <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="7" y1="10" x2="29" y2="10" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="13" y1="15" x2="29" y2="15" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="9" y1="20" x2="29" y2="20" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <line x1="15" y1="25" x2="29" y2="25" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            }
          </button>
        }
        @if (currentMode() === 'type') {
          <button class="control-btn add-text" (click)="addText()" aria-label="Add text box" title="Add text">
            <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><line x1="7.125" y1="10.125" x2="22.875" y2="10.125" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/><line x1="7.125" y1="14.625" x2="22.875" y2="14.625" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/><line x1="7.125" y1="19.125" x2="18.375" y2="19.125" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/><line x1="22.875" y1="28.875" x2="22.875" y2="19.125" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/><line x1="27.75" y1="23.625" x2="18" y2="23.625" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        } @else {
          <button class="control-btn add-text" (click)="setMode('type')" aria-label="Switch to text mode" title="Text mode">
            <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><line x1="7.125" y1="14.625" x2="28.875" y2="14.625" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/><line x1="7.125" y1="10.125" x2="28.875" y2="10.125" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/><line x1="7.125" y1="19.125" x2="28.875" y2="19.125" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/><line x1="7.125" y1="23.625" x2="18.375" y2="23.625" stroke="#FFFDF6" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        }
        <button class="control-btn draw" [class.active]="currentMode() === 'draw'" (click)="setMode('draw')" aria-label="Switch to drawing mode" title="Draw">
          <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.45996 19.2429C9.63746 17.5974 13.206 12.9219 17.3805 10.2924C20.52 8.31543 23.4855 10.9254 21.186 13.5534C18.9375 16.1244 15.921 19.6629 14.634 21.4194C13.299 23.2404 15.5835 25.4424 17.8695 23.3469C19.398 21.9459 20.9895 20.3349 22.6065 19.1439C24.7905 17.5374 26.664 18.9564 25.7115 20.7669C25.0215 22.0764 24.522 22.6539 23.9475 23.7564C23.3715 24.8574 23.9805 26.1789 24.852 26.2914C25.932 26.4324 26.616 25.6569 27.5385 24.4494" stroke="white" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="control-btn color-cycle" (click)="cycleColor()" aria-label="Cycle through colors" title="Change color" [style.--color]="currentColor()">
          <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2835_214959)"><path d="M16.8125 29.4721C17.6592 29.57 18.4794 29.2095 19.0819 28.6047C19.4434 28.2419 19.6465 27.7507 19.6465 27.2385C19.6465 26.7263 19.4434 26.235 19.0819 25.8723C18.4794 25.2675 17.9875 24.3667 18.4425 23.6432C20.2592 20.7553 29.6602 27.3894 29.6602 17.9987C29.6602 11.6203 24.5111 6.44922 18.1407 6.44922C11.7704 6.44922 6.68681 11.6287 6.62121 17.9987C6.57621 22.3677 9.05203 25.8934 11.8826 27.8725" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M24.4765 19.1209C25.4308 19.1209 26.2044 18.3473 26.2044 17.393C26.2044 16.4387 25.4308 15.665 24.4765 15.665C23.5222 15.665 22.7485 16.4387 22.7485 17.393C22.7485 18.3473 23.5222 19.1209 24.4765 19.1209Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.8048 19.1209C12.7591 19.1209 13.5328 18.3473 13.5328 17.393C13.5328 16.4387 12.7591 15.665 11.8048 15.665C10.8505 15.665 10.0769 16.4387 10.0769 17.393C10.0769 18.3473 10.8505 19.1209 11.8048 19.1209Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.0877 12.2089C17.0877 12.6672 16.9056 13.1067 16.5816 13.4307C16.2575 13.7548 15.818 13.9368 15.3598 13.9368C14.9015 13.9368 14.462 13.7548 14.1379 13.4307C13.8139 13.1067 13.6318 12.6672 13.6318 12.2089C13.6318 11.7506 13.8139 11.3111 14.1379 10.9871C14.462 10.663 14.9015 10.481 15.3598 10.481C15.818 10.481 16.2575 10.663 16.5816 10.9871C16.9056 11.3111 17.0877 11.7506 17.0877 12.2089ZM22.7495 12.2089C22.7495 12.6672 22.5675 13.1067 22.2434 13.4307C21.9194 13.7548 21.4799 13.9368 21.0216 13.9368C20.5633 13.9368 20.1238 13.7548 19.7998 13.4307C19.4757 13.1067 19.2937 12.6672 19.2937 12.2089C19.2937 11.7506 19.4757 11.3111 19.7998 10.9871C20.1238 10.663 20.5633 10.481 21.0216 10.481C21.4799 10.481 21.9194 10.663 22.2434 10.9871C22.5675 11.3111 22.7495 11.7506 22.7495 12.2089Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.4999 23.2189L12.4999 28.8319L6.89216 28.8319" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></g><circle cx="27.7495" cy="30.9688" r="4.25" fill="var(--color)" stroke="white" stroke-width="1.5"/><defs><clipPath id="clip0_2835_214959"><rect width="36" height="36" fill="white"/></clipPath></defs></svg>
        </button>
        <button class="control-btn submit" [disabled]="!hasContent()" (click)="submit()" aria-label="Submit artwork" title="Submit">
          <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="22" fill="#FFFDF6"/><g clip-path="url(#clip0_2834_214765)"><path d="M22 30V14M22 14L28 20M22 14L16 20" stroke="#4E02B2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g><defs><clipPath id="clip0_2834_214765"><rect width="24" height="24" fill="white" transform="translate(10 10)"/></clipPath></defs></svg>
        </button>
      </div>
    </div>
  }
</div>
