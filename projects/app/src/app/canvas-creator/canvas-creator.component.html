<div class="canvas-creator">
  <!-- Template Carousel -->
  @if (showTemplateGallery()) {
    <div class="template-carousel">
      <div class="header">
        <a [routerLink]="['/prescan']" queryParamsHandling="preserve" class="back">
          <img src="/icon-back.svg" alt="Back">
        </a>
        <h2 i18n>Choose a Template</h2>
      </div>
      <div class="carousel-container"
           (touchstart)="onCarouselTouchStart($event)"
           (touchmove)="onCarouselTouchMove($event)"
           (touchend)="onCarouselTouchEnd()">
        @if (currentTemplate(); as current) {
          <button class="carousel-nav prev" (click)="previousTemplate()" aria-label="Previous template">
            ‚Äπ
          </button>
          <div class="carousel-slide" (click)="useCurrentTemplate()">
            <img [src]="current.preview" [alt]="current.name">
            <div class="template-info">{{ current.name }}</div>
          </div>
          <button class="carousel-nav next" (click)="nextTemplate()" aria-label="Next template">
            ‚Ä∫
          </button>
        }
      </div>
      <!-- Tapping the slide selects; keep button for accessibility -->
      <button class="button primary use-template" (click)="useCurrentTemplate()" i18n>
        Use this template
      </button>
    </div>
  }
  
  <!-- Canvas Editor -->
  @if (selectedTemplate() && !showTemplateGallery()) {
    <div class="editor">
      <!-- Top drawer overlay controls -->
      <div class="top-drawer" [class.state-default]="drawerState() === 'default'" [class.state-full]="drawerState() === 'full'" [class.state-minimal]="drawerState() === 'minimal'"
           [style.transform]="drawerTransform()" [style.transition]="drawerTransition()">
        <div class="drawer-content" (touchstart)="onDrawerTouchStart($event)" (touchmove)="onDrawerTouchMove($event)" (touchend)="onDrawerTouchEnd()">
          <!-- Advanced (only in full) -->
          @if (drawerState() === 'full') {
          <div class="row extended advanced">
            <button class="icon" (click)="addText()" aria-label="Add text">‚ûïT</button>
            <button class="icon" (click)="addTransitionText()" aria-label="Add transition text">T‚Üï</button>
            <div class="font-picker">
              <select [value]="selectedFont()" (change)="setFont(($any($event.target)).value)">
                @for (f of handwritingFonts; track f) {
                  <option [value]="f">{{ f }}</option>
                }
              </select>
            </div>
            <button class="icon" (click)="undo()" aria-label="Undo">‚Ü©Ô∏é</button>
          </div>
          <div class="row extended advanced">
            <div class="line-height-control">
              <label for="line-height">Line Height</label>
              <input type="range" id="line-height" min="0.8" max="2" step="0.1" 
                     [value]="selectedLineHeight()" 
                     (input)="setLineHeight(+($any($event.target)).value)">
              <span>{{ (selectedLineHeight() * 100).toFixed(0) }}%</span>
            </div>
            <div class="line-height-control">
              <label for="text-height">Height</label>
              <input type="range" id="text-height" min="20" max="200" step="5" 
                     [value]="selectedHeight()" 
                     (input)="setHeight(+($any($event.target)).value)">
              <span>{{ selectedHeight() }}px</span>
            </div>
            <div class="transition-selector inline">
              <button class="chip" [class.selected]="transitionChoice() === 'before'" (click)="selectTransition('before')" i18n>Before</button>
              <button class="chip" [class.selected]="transitionChoice() === 'during'" (click)="selectTransition('during')" i18n>During</button>
              <button class="chip" [class.selected]="transitionChoice() === 'after'" (click)="selectTransition('after')" i18n>After</button>
            </div>
          </div>
          }

          <!-- Basic buttons (default & full) -->
          @if (drawerState() !== 'minimal') {
          <div class="row core">
            <button class="icon" [class.active]="currentMode() === 'type'" (click)="setMode('type')" aria-label="Text mode">‚úçÔ∏è</button>
            <button class="icon" [class.active]="currentMode() === 'draw'" (click)="setMode('draw')" aria-label="Draw mode">üñä</button>
            <button class="icon" (click)="clearCanvas()" aria-label="Clear">üóë</button>
            <button class="icon primary" (click)="submit()" aria-label="Submit">‚§¥</button>
          </div>
          }
        </div>
        <div class="drawer-handle" (click)="toggleControls()" (touchstart)="onDrawerTouchStart($event)" (touchmove)="onDrawerTouchMove($event)" (touchend)="onDrawerTouchEnd()" aria-label="Toggle controls" role="button" tabindex="0"></div>
      </div>
      
      <div class="canvas-container">
        <canvas #canvasEl></canvas>
      </div>
    </div>
  }
</div>
