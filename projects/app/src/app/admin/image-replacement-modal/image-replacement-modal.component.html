<div class="modal-overlay" (click)="close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Replace Image</h2>
      <button class="close-button" (click)="close()" aria-label="Close dialog">Ã—</button>
    </div>
    
    @if (!showComparison()) {
      @if (selectedOption() === null) {
        <div class="modal-body">
          <p>Choose how to replace the image:</p>
          <div class="buttons">
            <button class="button primary" (click)="selectOption('upload')">
              Upload from File System
            </button>
            <button class="button primary" (click)="selectOption('existing')">
              Use Existing Image
            </button>
            <button class="button primary" (click)="selectOption('scan')">
              Scan Again
            </button>
          </div>
        </div>
      }
      
      @if (selectedOption() === 'upload') {
        <div class="modal-body">
          <h3>Upload Image</h3>
          <p>Select an image file from your device:</p>
          <input 
            type="file" 
            accept="image/*" 
            (change)="onFileSelected($event)"
            [disabled]="uploading()"
          >
          <div class="buttons">
            <button class="button" (click)="selectedOption.set(null)" [disabled]="uploading()">
              Back
            </button>
          </div>
        </div>
      }
      
      @if (selectedOption() === 'existing') {
        <div class="modal-body">
          <h3>Select Existing Image</h3>
          <p>Choose an image from another item in this workspace:</p>
          @if (workspaceItems().length === 0 && !uploading()) {
            <p class="no-items">No other items with images found in this workspace.</p>
          } @else {
            <div class="items-grid">
              @for (item of workspaceItems(); track item._id) {
                <div 
                  class="item-thumbnail" 
                  [class.selected]="selectedItemId() === item._id"
                  (click)="selectExistingImage(item._id)"
                >
                  <img [src]="item.screenshot_url" [alt]="item.future_scenario_tagline || 'Item image'">
                  @if (item.future_scenario_tagline) {
                    <div class="item-label">{{ item.future_scenario_tagline }}</div>
                  }
                </div>
              }
            </div>
          }
          <div class="buttons">
            <button class="button" (click)="selectedOption.set(null)" [disabled]="uploading()">
              Back
            </button>
            <button 
              class="button primary" 
              (click)="confirmExistingImage()"
              [disabled]="!selectedItemId() || uploading()"
            >
              @if (uploading()) {
                Replacing...
              } @else {
                Compare Images
              }
            </button>
          </div>
        </div>
      }
      
      @if (selectedOption() === 'scan') {
        <div class="modal-body">
          <h3>Scan New Image</h3>
          <p>You will be redirected to the scanner to capture a new image.</p>
          <p><strong>Note:</strong> This works best on mobile devices.</p>
          <div class="buttons">
            <button class="button" (click)="selectedOption.set(null)">
              Back
            </button>
            <button class="button primary" (click)="scanAgain()">
              Open Scanner
            </button>
          </div>
        </div>
      }
    } @else {
      <div class="modal-body comparison-modal">
        <app-image-comparison
          [currentImage]="currentImageUrl()"
          [newImage]="pendingNewImage()!"
          (approved)="selectedOption() === 'existing' ? onExistingComparisonApproved() : onComparisonApproved()"
          (cancelled)="onComparisonCancelled()"
        />
      </div>
    }
  </div>
</div>
