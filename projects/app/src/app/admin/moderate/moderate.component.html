<div class="moderate-container">
  <header class="topbar" role="banner">
    <div class="brand">
      <span class="logo" aria-hidden="true">‚ú¶</span>
      <h1>Content Moderation</h1>
      @if (workspace()?.source) {
        <span class="workspace-name">{{ workspace()?.source }}</span>
      }
    </div>
    <div class="actions">
      <div class="cred-inline">
        <input 
          type="text" 
          [(ngModel)]="workspaceId" 
          placeholder="workspace"
          aria-label="Workspace ID" />
        <input 
          type="text" 
          [(ngModel)]="apiKey" 
          placeholder="api key"
          aria-label="API key" />
      </div>
      <a href="/admin" class="back-link" aria-label="Back to admin">‚Üê Back</a>
    </div>
  </header>

  <app-filters-bar
    [counts]="getFilterCounts()"
    [totalCount]="allFetchedItems().length"
    [filteredCount]="items().length"
    [showViewToggle]="true"
    [initialState]="filterState()"
    (filtersChange)="onFiltersChange($event)"
    (filtersCommit)="onFiltersCommit($event)"
  ></app-filters-bar>

  @if (items().length === 500 || page() > 0) {
    <section class="pagination-section" aria-label="Pagination">
      <button 
        class="pagination-btn" 
        [disabled]="page() === 0" 
        (click)="page.set(page() - 1)"
        aria-label="Previous page">
        ‚Üê Previous
      </button>
      <span class="page-info">Page {{ page() + 1 }}</span>
      <button 
        class="pagination-btn" 
        [disabled]="!items().length" 
        (click)="page.set(page() + 1)"
        aria-label="Next page">
        Next ‚Üí
      </button>
    </section>
  }

  @if (indexLink()) {
    <div class="index-notice" role="alert">
      <span>‚ö†Ô∏è Database index required</span>
      <a [href]="indexLink()" target="_blank" class="index-link">Create index</a>
    </div>
  } @else {
    @if (viewMode() === 'grid') {
      <div class="grid-layout">
        @if (selectedItem()) {
          <div class="lightbox-overlay" (click)="closeSidebar()" role="dialog" aria-modal="true" aria-labelledby="lightbox-title">
            <div class="lightbox-container" [class.sidebar-open]="lightboxSidebarOpen()">
              <div class="lightbox-content" (click)="$event.stopPropagation()">
                <button class="lightbox-close-btn" (click)="closeSidebar()" aria-label="Close lightbox">√ó</button>
                <button class="lightbox-sidebar-toggle-btn" (click)="toggleLightboxSidebar()" aria-label="Toggle sidebar">‚ãÆ</button>
                
                <button class="nav-btn nav-prev" (click)="prevItem()" [disabled]="selectedItemIndex() <= 0" aria-label="Previous item">‚Üê</button>
                <button class="nav-btn nav-next" (click)="nextItem()" [disabled]="selectedItemIndex() >= items().length - 1" aria-label="Next item">‚Üí</button>
                
                <div class="lightbox-main">
                  <div class="lightbox-info-boxes">
                    <div class="info-box info-box-screenshot-type">
                      <label for="screenshot-type">Screenshot Type</label>
                      <select 
                        id="screenshot-type"
                        [(ngModel)]="selectedItem().screenshot_type"
                        (change)="autoSaveScreenshotType(selectedItem())"
                        aria-label="Select screenshot type">
                        <option [value]="null">Select type...</option>
                        <option value="sign_in_a_demonstration">ü™ß Sign</option>
                        <option value="social_media_post">üì£ Social</option>
                        <option value="chat_conversation">üí¨ Chat</option>
                        <option value="notification_alert">üîî Alert</option>
                        <option value="ai_agent_query">ü§ñ AI</option>
                        <option value="review">‚≠ê Review</option>
                        <option value="map_visualization">üó∫Ô∏è Map</option>
                        <option value="photograph">üì∏ Photo</option>
                      </select>
                    </div>

                    <div class="info-box info-box-content">
                      <label for="content-input">Content</label>
                      <textarea 
                        id="content-input"
                        [(ngModel)]="selectedItem().content"
                        (change)="autoSaveContent(selectedItem())"
                        placeholder="Enter content..."
                        aria-label="Edit content"></textarea>
                    </div>

                    <div class="info-box info-box-transition">
                      <div class="transition-content">
                        <div class="transition-event-input">
                          <input 
                            id="transition-event"
                            type="text"
                            [(ngModel)]="selectedItem().transition_bar_event"
                            (change)="autoSaveTransitionBarEvent(selectedItem())"
                            [placeholder]="!selectedItem().transition_bar_event ? 'unclear' : ''"
                            aria-label="Edit transition event" />
                        </div>

                        <div class="radio-group-inline">
                          @if (selectedItem().transition_bar_event && selectedItem().transition_bar_event !== 'unclear') {
                            <label class="radio-label">
                              <input 
                                type="radio"
                                name="position"
                                value="before"
                                [(ngModel)]="selectedItem().transition_bar_position"
                                (change)="autoSaveTransitionBarPosition(selectedItem())"
                                aria-label="Before" />
                              <span>Before</span>
                            </label>
                            <label class="radio-label">
                              <input 
                                type="radio"
                                name="position"
                                value="during"
                                [(ngModel)]="selectedItem().transition_bar_position"
                                (change)="autoSaveTransitionBarPosition(selectedItem())"
                                aria-label="During" />
                              <span>During</span>
                            </label>
                            <label class="radio-label">
                              <input 
                                type="radio"
                                name="position"
                                value="after"
                                [(ngModel)]="selectedItem().transition_bar_position"
                                (change)="autoSaveTransitionBarPosition(selectedItem())"
                                aria-label="After" />
                              <span>After</span>
                            </label>
                          }
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="lightbox-image-container">
                    <img [src]="selectedItem().screenshot_url" alt="Future scenario screenshot" id="lightbox-title" />
                  </div>
                </div>

                <div class="lightbox-counter">{{ selectedItemIndex() + 1 }} / {{ items().length }}</div>
              </div>

              @if (lightboxSidebarOpen()) {
                <aside class="lightbox-sidebar" role="complementary" (click)="$event.stopPropagation()">
                  <div class="sidebar-header">
                    <h2>Item Details</h2>
                    <button class="close-sidebar-btn" (click)="toggleLightboxSidebar()" aria-label="Close sidebar">√ó</button>
                  </div>
                  <div class="sidebar-content">
                    <article class="item-card" [attr.data-status]="LEVELS[selectedItem()._private_moderation]">
                    <div class="card-header">
                      <button class="user-info" (click)="filterByUser(selectedItem().author_id)" [title]="getEmail(selectedItem())">
                    @if (selectedItem().author_id && selectedItem().author_id !== 'unknown') {
                      <span class="user-count-link">{{ getUserItemCount(selectedItem().author_id) }} items</span>
                    } @else {
                      <span class="user-count-link">{{ getUserItemCount('unknown') }} unattributed</span>
                    }
                  </button>
                    </div>

                    <div class="card-metadata">
                          <div class="metadata-row">
                        <span class="date">{{ formatDate(selectedItem().created_at) }}</span>
                        <button 
                          class="icon-btn star-btn" 
                          [class.active]="selectedItem()._private_moderation === 5"
                          (click)="highlight(selectedItem()._id)"
                          aria-label="Highlight">
                          {{ selectedItem()._private_moderation === 5 ? '‚òÖ' : '‚òÜ' }}
                        </button>
                        <span class="ai-confidence" [attr.data-confidence]="getConfidenceLevel(selectedItem())">
                          AI: {{ getAIConfidence(selectedItem()) }}%
                        </span>
                        <button class="icon-btn trash-btn" (click)="reject(selectedItem()._id)" aria-label="Archive">
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>

                    <div class="card-content">
                      <div class="tagline-section">
                        @if (editTagline() === selectedItem()._id) {
                          <div class="tagline-edit">
                            <textarea 
                              [(ngModel)]="selectedItem().future_scenario_tagline" 
                              placeholder="Enter tagline"
                              rows="3"
                              aria-label="Edit tagline"></textarea>
                            <div class="edit-actions">
                              <button class="btn-icon btn-save" (click)="setTagline(selectedItem())" aria-label="Save">‚úì</button>
                              <button class="btn-icon btn-cancel" (click)="editTagline.set(null)" aria-label="Cancel">‚úï</button>
                            </div>
                          </div>
                        } @else {
                          @if (selectedItem().future_scenario_tagline) {
                            <div class="tagline" (click)="editTagline.set(selectedItem()._id)" role="button" tabindex="0">
                              {{ selectedItem().future_scenario_tagline }}
                            </div>
                          } @else {
                            <div class="tagline tagline-empty" (click)="editTagline.set(selectedItem()._id)" role="button" tabindex="0">
                              + Add tagline
                            </div>
                          }
                        }
                      </div>

                      <div class="tags-section">
                        <div class="tags-container">
                          @if (selectedItem().tags && selectedItem().tags.length > 0) {
                            @for (tag of selectedItem().tags; track $index) {
                              <span class="tag">
                                {{ tag }}
                                <button class="tag-remove" (click)="removeTag(selectedItem(), $index)" aria-label="Remove tag">√ó</button>
                              </span>
                            }
                          }
                          <div class="tag-input-wrapper">
                            <input 
                              #tagInput
                              type="text" 
                              class="tag-input" 
                              placeholder="+ Add tag"
                              (keydown.enter)="addTag(selectedItem(), tagInput)"
                              aria-label="Add new tag" />
                          </div>
                        </div>
                      </div>

                      <div class="properties-selectors">
                        <div class="property-selector">
                          <select 
                            [(ngModel)]="selectedItem().favorable_future" 
                            (change)="setFavorable(selectedItem())"
                            [class]="'desirability-select ' + getDesirabilityClass(selectedItem().favorable_future)"
                            aria-label="Set desirability">
                            <option [value]="null">Desirability?</option>
                            <option value="prefer">prefer</option>
                            <option value="mostly prefer">prefer-ish</option>
                            <option value="uncertain">uncertain</option>
                            <option value="mostly prevent">prevent-ish</option>
                            <option value="prevent">prevent</option>
                          </select>
                        </div>
                        <div class="property-selector">
                          <select 
                            [(ngModel)]="selectedItem().plausibility" 
                            (change)="setPlausibility(selectedItem())"
                            [class]="'plausibility-select ' + getPlausibilityClass(selectedItem().plausibility)"
                            aria-label="Set plausibility">
                            <option [value]="null">Plausibility?</option>
                            <option [value]="100">Projected</option>
                            <option [value]="75">Probable</option>
                            <option [value]="50">Plausible</option>
                            <option [value]="25">Possible</option>
                            <option [value]="0">Preposterous</option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer">
                      <button 
                        class="publish-btn"
                        [class.published]="selectedItem()._private_moderation >= 4"
                        [class.archived]="selectedItem()._private_moderation === 0"
                        (click)="selectedItem()._private_moderation === 0 ? unarchive(selectedItem()._id) : approve(selectedItem()._id)"
                        [attr.aria-label]="selectedItem()._private_moderation === 0 ? 'Unarchive' : (selectedItem()._private_moderation >= 4 ? 'Published' : 'Publish')">
                        @if (selectedItem()._private_moderation === 0) {
                          <span class="btn-default">ARCHIVED üóëÔ∏è</span>
                          <span class="btn-hover">UNARCHIVE</span>
                        } @else if (selectedItem()._private_moderation >= 4) {
                          PUBLISHED ‚úì
                        } @else {
                          PUBLISH
                        }
                      </button>
                    </div>
                  </article>
                  </div>
                </aside>
              }
            </div>
          </div>
        }
        <div class="thumbnails-grid" role="list">
          @for (item of items(); track item._id) {
            <div class="thumbnail-item" [attr.data-status]="LEVELS[item._private_moderation]" (click)="selectItem(item)" role="button" tabindex="0" [class.selected]="selectedItem()?._id === item._id">
              <img [src]="item.screenshot_url" alt="Future scenario screenshot" />
            </div>
          }
        </div>
      </div>
    } @else {
      <div class="items-grid" role="list">
        @for (item of items(); track item._id) {
          <article class="item-card" [attr.data-status]="LEVELS[item._private_moderation]" role="listitem">
            <div class="card-header">
              <button class="user-info" (click)="filterByUser(item.author_id)" [title]="getEmail(item)">
                @if (item.author_id && item.author_id !== 'unknown') {
                  <span class="user-count-link">{{ getUserItemCount(item.author_id) }} items</span>
                } @else {
                  <span class="user-count-link">{{ getUserItemCount('unknown') }} unattributed</span>
                }
              </button>
              <span class="screenshot-type" [title]="item.screenshot_type || 'screenshot'">{{ getScreenshotTypeEmoji(item.screenshot_type) }}</span>
            </div>

            <div class="screenshot-container">
              @if (!isShowingDescription(item._id)) {
              <img [src]="item.screenshot_url" alt="Future scenario screenshot" />
              <button class="toggle-view-btn" (click)="toggleDescriptionView(item._id)" aria-label="Show description">
                ‚ÑπÔ∏è
              </button>
            } @else {
              @if (editDescription() === item._id) {
                <div class="description-edit">
                  <div class="field-group">
                    <label>Content</label>
                    <textarea 
                      [(ngModel)]="item.content" 
                      placeholder="Enter content"
                      rows="4"
                      aria-label="Edit content"></textarea>
                  </div>
                  <div class="field-group">
                    <label>Description</label>
                    <textarea 
                      [(ngModel)]="item.future_scenario_description" 
                      placeholder="Enter description"
                      rows="4"
                      aria-label="Edit description"></textarea>
                  </div>
                  <div class="edit-actions">
                    <button class="btn-icon btn-save" (click)="setDescription(item)" aria-label="Save">‚úì</button>
                    <button class="btn-icon btn-cancel" (click)="editDescription.set(null)" aria-label="Cancel">‚úï</button>
                  </div>
                </div>
              } @else {
                <div class="description-view" (click)="editDescription.set(item._id)" role="button" tabindex="0">
                  @if (item.content || item.future_scenario_description) {
                    @if (item.content) {
                      <div class="field-display">
                        <strong>Content:</strong>
                        <p>{{ item.content }}</p>
                      </div>
                    }
                    @if (item.future_scenario_description) {
                      <div class="field-display">
                        <strong>Description:</strong>
                        <p>{{ item.future_scenario_description }}</p>
                      </div>
                    }
                  } @else {
                    <p class="description-empty">+ Add content and description</p>
                  }
                </div>
              }
              <button class="toggle-view-btn" (click)="toggleDescriptionView(item._id)" aria-label="Show image">
                üñºÔ∏è
              </button>
            }
          </div>

          <div class="card-metadata">
            <div class="metadata-row">
              <span class="date">{{ formatDate(item.created_at) }}</span>
              <button 
                class="icon-btn star-btn" 
                [class.active]="item._private_moderation === 5"
                (click)="highlight(item._id)"
                aria-label="Highlight">
                {{ item._private_moderation === 5 ? '‚òÖ' : '‚òÜ' }}
              </button>
              <span class="ai-confidence" [attr.data-confidence]="getConfidenceLevel(item)">
                AI: {{ getAIConfidence(item) }}%
              </span>
              <button class="icon-btn trash-btn" (click)="reject(item._id)" aria-label="Archive">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div class="card-content">
            <div class="tagline-section">
              @if (editTagline() === item._id) {
                <div class="tagline-edit">
                  <textarea 
                    [(ngModel)]="item.future_scenario_tagline" 
                    placeholder="Enter tagline"
                    rows="3"
                    aria-label="Edit tagline"></textarea>
                  <div class="edit-actions">
                    <button class="btn-icon btn-save" (click)="setTagline(item)" aria-label="Save">‚úì</button>
                    <button class="btn-icon btn-cancel" (click)="editTagline.set(null)" aria-label="Cancel">‚úï</button>
                  </div>
                </div>
              } @else {
                @if (item.future_scenario_tagline) {
                  <div class="tagline" (click)="editTagline.set(item._id)" role="button" tabindex="0">
                    {{ item.future_scenario_tagline }}
                  </div>
                } @else {
                  <div class="tagline tagline-empty" (click)="editTagline.set(item._id)" role="button" tabindex="0">
                    + Add tagline
                  </div>
                }
              }
            </div>

            <div class="tags-section">
              <div class="tags-container">
                @if (item.tags && item.tags.length > 0) {
                  @for (tag of item.tags; track $index) {
                    <span class="tag">
                      {{ tag }}
                      <button class="tag-remove" (click)="removeTag(item, $index)" aria-label="Remove tag">√ó</button>
                    </span>
                  }
                }
                <div class="tag-input-wrapper">
                  <input 
                    #tagInput
                    type="text" 
                    class="tag-input" 
                    placeholder="+ Add tag"
                    (keydown.enter)="addTag(item, tagInput)"
                    aria-label="Add new tag" />
                </div>
              </div>
            </div>

            <div class="properties-selectors">
              <div class="property-selector">
                <select 
                  [(ngModel)]="item.favorable_future" 
                  (change)="setFavorable(item)"
                  [class]="'desirability-select ' + getDesirabilityClass(item.favorable_future)"
                  aria-label="Set desirability">
                  <option [value]="null">Desirability?</option>
                  <option value="prefer">prefer</option>
                  <option value="mostly prefer">prefer-ish</option>
                  <option value="uncertain">uncertain</option>
                  <option value="mostly prevent">prevent-ish</option>
                  <option value="prevent">prevent</option>
                </select>
              </div>
              <div class="property-selector">
                <select 
                  [(ngModel)]="item.plausibility" 
                  (change)="setPlausibility(item)"
                  [class]="'plausibility-select ' + getPlausibilityClass(item.plausibility)"
                  aria-label="Set plausibility">
                  <option [value]="null">Plausibility?</option>
                  <option [value]="100">Projected</option>
                  <option [value]="75">Probable</option>
                  <option [value]="50">Plausible</option>
                  <option [value]="25">Possible</option>
                  <option [value]="0">Preposterous</option>
                </select>
              </div>
            </div>
          </div>

          <div class="card-footer">
            <button 
              class="publish-btn"
              [class.published]="item._private_moderation >= 4"
              [class.archived]="item._private_moderation === 0"
              (click)="item._private_moderation === 0 ? unarchive(item._id) : approve(item._id)"
              [attr.aria-label]="item._private_moderation === 0 ? 'Unarchive' : (item._private_moderation >= 4 ? 'Published' : 'Publish')">
              @if (item._private_moderation === 0) {
                <span class="btn-default">ARCHIVED üóëÔ∏è</span>
                <span class="btn-hover">UNARCHIVE</span>
              } @else if (item._private_moderation >= 4) {
                PUBLISHED ‚úì
              } @else {
                PUBLISH
              }
            </button>
          </div>
        </article>
      }
    </div>
  }
}
